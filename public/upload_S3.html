<!DOCTYPE html>
<html>
<head>
	<title>upload test to AWS S3</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>
	<h1>upload test to AWS S3</h1>
	<hr>

	<input type="file" id="file-input">
	<p id="status">Please select a file</p>
	<button id="btn-del">Delete</button>
	<br><br>

	<img id="preview" src="/images/default.png" style="max-width: 500px">

	<form method="POST" action="/save-details">
		<input type="hidden" id="avatar-url" name="avatar-url" value="/images/default.png">
		<input type="text" name="username" placeholder="Username"><br>
		<input type="text" name="full-name" placeholder="Full name"><br><br>
		<input type="submit" value="Update profile">
	</form>

	<script type="text/javascript">
		$("#file-input").on("change", function() {
			const files = document.getElementById('file-input').files;
			const file = files[0];
			if(file == null){
				return alert('No file selected.');
			}
			getSignedRequest(file);
		});

		function getSignedRequest(file){
			$.ajax({
				url: `/sign-s3?file-name=${file.name}&file-type=${file.type}`,
				method: "GET",
			}).done(function(res) {
				console.log(res);
				uploadFile(file, res.signedRequest, res.url);
			});
		}

		function uploadFile(file, signedRequest, url){
			const xhr = new XMLHttpRequest();
			xhr.open('PUT', signedRequest);
			xhr.onreadystatechange = () => {
				if(xhr.readyState === 4){
					if(xhr.status === 200){
						document.getElementById('preview').src = url;
						document.getElementById('avatar-url').value = url;
					}
					else{
						alert('Could not upload file.');
					}
				}
			};
			xhr.send(file);
		}

		$("#btn-del").on("click", function() {
			const files = document.getElementById('file-input').files;
			const file = files[0];
			if(file == null){
				return alert('No file selected.');
			}

			$.ajax({
				url: `/sign-s3/${file.name}`, 
				method: "DELETE",
			}).done(function(data) {
				console.log(data);
			});
		});

	</script>
</body>
</html>

